<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <script src=../../media-resources/video-test.js></script>
        <script src=../../media-resources/media-file.js></script>

        <script>
            var track;
            var cuechangeCount = 0;
            var loadCount = 0;
            var cueJSON = [
                 '{"value":{"key":"TIT2","data":"Stream Counting"}}',
                 '{"value":{"key":"TPE1","data":"Andy"}}',
                 '{"value":{"key":"TALB","data":"Greatest Hits"}}',
                 '{"value":{"data":{},"info":"Our Hero","key":"GEOB","name":"abe.png","type":"image/png"}}',
                 '{"value":{"data":{},"key":"APIC","type":"image/png","dataType":"Movie/video screen capture"}}',
                 '{"value":{"key":"TXXX","data":"Text Blob"}}'
            ];
            var imageSizes = [ [76, 103], [100, 100] ];
        
            function addtrack(event)
            {
                tracks = event.target;
                testExpected("tracks.length", "1");
                run("track = video.textTracks[0]");
                testExpected("track.kind", "metadata");
                testExpected("track.mode", "disabled");
                run("track.mode = 'hidden'");
                track.addEventListener('cuechange', cuechange, true);
            }
            
            function imageLoad()
            {
                testExpected("imageElement.width", imageSizes[loadCount][0]);
                testExpected("imageElement.height", imageSizes[loadCount][1]);
                consoleWrite("");

                if (++loadCount == 2) {
                    endTest();
                    return;
                }

                testImage(4);
            }

            function testImage(cueIndex)
            {
                run("cueImageData = track.cues[" + cueIndex + "].value.data");
                testExpected("cueImageData instanceof ArrayBuffer", true);
                run("blobUrl = URL.createObjectURL(new Blob([cueImageData], { type: 'image/png' } ))");
                imageElement = document.querySelector("#photo");
                run("imageElement.src = blobUrl");
            }
            
            function cuechange(event)
            {
                consoleWrite("EVENT(cuechange)");
                if (++cuechangeCount != 6)
                    return;

                consoleWrite("<br><i>** Validate cue data</i>");
                track.removeEventListener("cuechange", cuechange, true);
                video.pause();
                
                for (var i = 0; i < 6; i++) {
                    cue = track.cues[i];
                    testExpected("cue.type", "org.id3");
                    testExpected("cue.data", null);
                    testExpected("'" + JSON.stringify(cue) + "'", cueJSON[i]);
                    consoleWrite("");
                }

                consoleWrite("<i>** Extract images from cue data, validate by setting img.src</i>");
                imageElement = document.querySelector("#photo");
                waitForEvent('load', imageLoad, false, false, imageElement)
                testImage(3);
            }

            function canplaythrough()
            {
                consoleWrite("<br><i>** Start playback, wait for all cues to load</i>");
                video.play(); 
            }

            function start()
            {
                consoleWrite("<br><i>** Set video.src, wait for media data to load</i>");
                findMediaElement();
                video.src = "http://127.0.0.1:8000/media/resources/hls/metadata/prog_index.m3u8";

                waitForEvent("canplaythrough", canplaythrough);
                waitForEvent('addtrack', addtrack, false, false, video.textTracks);
            }
        </script>
    </head>
    <body onload="start()">
        <video controls></video>
        <img id=photo>
        <p>Test for metadata tracks from Apple HLS stream.</p>
    </body>
</html>
