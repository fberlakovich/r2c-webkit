<!DOCTYPE html>
<html>
<body>
<p>This tests that JS wrappers of nodes in a tree mutation record do not get collected.</p>
<pre id="log"></pre>
<script>

if (window.testRunner)
    testRunner.dumpAsText();

const nodeCount = 20;
const iterationCount = window.GCController ? 20 : 50;
const observer = new MutationObserver((recordList) => {
    let deadCount = 0;
    for (const record of recordList) {
        for (const node of record.addedNodes) {
            if (node.myState != 'alive')
                deadCount++;
        }
        triggerGC();
        for (const node of record.removedNodes) {
            if (node.myState != 'alive')
                deadCount++;
        }
    }
    document.getElementById('log').textContent += (deadCount ? `FAIL - ${deadCount} nodes lost JS wrappers` : 'PASS') + '\n';
});

function runTest() {
    let container = document.createElement('div');
    container.innerHTML = '<div></div>';
    container.firstChild.myState = 'alive';
    observer.observe(container, {subtree: true, childList: true});

    // Test transient registrations.
    for (let i = 0; i < nodeCount; ++i) {
        const child = document.createElement('span');
        child.myState = 'alive';
        child.appendChild(document.createElement('span')).myState = 'alive';
        container.firstChild.appendChild(child);
        child.textContent = '';
    }
    container.textContent = '';

    // Test pending targets.
    for (let i = 0; i < nodeCount; ++i)
        container.appendChild(document.createElement('span')).myState = 'alive';
}

function triggerGC() {
    if (window.GCController) {
        GCController.collect();
        return;
    } 

    const elements = new Array(nodeCount)
    for (let i = 0; i < nodeCount; ++i)
        elements[i] = document.createElement('span');

    const x = new Array(1000);
    for (let i = 0; i < 1000; ++i)
        x[i] = new Array(100);
}

async function runAll() {
    if (window.testRunner)
        testRunner.waitUntilDone();

    for (let j = 0; j < iterationCount; ++j) {
        runTest();
        triggerGC();
        await Promise.resolve();
    }

    if (window.testRunner)
        testRunner.notifyDone();
}

runAll();

</script>
</body>
</html>
