<!doctype html>
<html>
<head>
<script src="../../http/tests/inspector/resources/inspector-test.js"></script>
<script>
function createBlockedResourceLoad() {
    testRunner.setWillSendRequestReturnsNull(true);

    let img = document.createElement("img");
    img.src = "does-not-exist.png";
    document.body.appendChild(img);
}

function test()
{
    let suite = InspectorTest.createAsyncSuite("ClientBlockedResourceLoad");

    suite.addTestCase({
        name: "TriggerBlockedResourceLoad",
        description: "Trigger a blocked resource load and ensure we get notified of the request.",
        test(resolve, reject) {
            Promise.all([
                WebInspector.Frame.awaitEvent(WebInspector.Frame.Event.ResourceWasAdded),
                WebInspector.Resource.awaitEvent(WebInspector.Resource.Event.LoadingDidFail)
            ])
            .then(([resourceWasAddedEvent, loadingDidFailEvent]) => {
                let resource = resourceWasAddedEvent.data.resource;
                InspectorTest.expectThat(resource instanceof WebInspector.Resource, "Resource should be created.");
                InspectorTest.expectThat(resource === loadingDidFailEvent.target, "Added Resource load did fail.");
                InspectorTest.expectThat(resource.url === "", "Request url should be rewritten to the null string.");
            })
            .then(resolve, reject);

            InspectorTest.evaluateInPage("createBlockedResourceLoad()");
        }
    });

    suite.runTestCasesAndFinish();
}
</script>
</head>
<body onload="runTest()">
<p>Tests that there is no crash when the client blocks a resource load.</p>
</body>
</html>
