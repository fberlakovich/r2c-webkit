<!DOCTYPE html>
<html>
<head>
<script src="../../http/tests/inspector/resources/inspector-test.js"></script>
<script src="./resources/timeline-event-utilities.js"></script>
<script>
function testSetTimeout() {
    let setTimeoutIdentifier = setTimeout(() => { TestPage.addResult("FAIL: setTimeout fired"); });
    clearTimeout(setTimeoutIdentifier);
    requestAnimationFrame(() => { finishRecording({setTimeoutIdentifier}); }); // Delay a bit to ensure we get the clear timeout.
}

function testSetInterval() {
    let count = 0;
    let setIntervalIdentifier = setInterval(() => {
        count++;
        TestPage.addResult("setInterval fired: " + count);
        if (count === 3) {
            clearInterval(setIntervalIdentifier);
            requestAnimationFrame(() => { finishRecording({setIntervalIdentifier}); }); // Delay a bit to ensure we get the clear timeout.
        }
    });
}

function test()
{
    let suite = InspectorTest.createAsyncSuite("TimelineEvent.TimerRemove");

    let timeoutIdentifier;
    let intervalIdentifier;

    suite.addTestCase({
        name: "TimelineEvent.TimerRemove.setTimeout",
        test(resolve, reject) {
            captureTimelineWithScript(`testSetTimeout()`).then(() => {
                InspectorTest.assert(typeof pageRecordingData.setTimeoutIdentifier === "number");
                timeoutIdentifier = pageRecordingData.setTimeoutIdentifier;

                let recording = WI.timelineManager.activeRecording;
                let scriptTimeline = recording.timelines.get(WI.TimelineRecord.Type.Script);
                let records = scriptTimeline.records.filter((x) => x.eventType === WI.ScriptTimelineRecord.EventType.TimerRemoved);
                InspectorTest.expectEqual(records.length, 1, "Should be 1 TimerRemoved record.");
                for (let record of records) {
                    InspectorTest.log("DETAILS: " + typeof record.details);
                    InspectorTest.expectEqual(record.details, timeoutIdentifier, "ScriptTimelineRecord details should be the setTimeout identifier.");
                }
            }).then(resolve, reject);
        }
    });

    suite.addTestCase({
        name: "TimelineEvent.TimerRemove.setInterval",
        test(resolve, reject) {
            captureTimelineWithScript(`testSetInterval()`).then(() => {
                InspectorTest.assert(typeof pageRecordingData.setIntervalIdentifier === "number");
                intervalIdentifier = pageRecordingData.setIntervalIdentifier;

                let recording = WI.timelineManager.activeRecording;
                let scriptTimeline = recording.timelines.get(WI.TimelineRecord.Type.Script);
                let records = scriptTimeline.records.filter((x) => x.eventType === WI.ScriptTimelineRecord.EventType.TimerRemoved);
                InspectorTest.expectEqual(records.length, 1, "Should be 1 TimerRemoved record.");
                for (let record of records) {
                    InspectorTest.log("DETAILS: " + typeof record.details);
                    InspectorTest.expectEqual(record.details, pageRecordingData.setIntervalIdentifier, "ScriptTimelineRecord details should be the setInterval identifier.");
                }
            }).then(resolve, reject);
        }
    });

    suite.addTestCase({
        name: "SanityCheck",
        test(resolve, reject) {
            InspectorTest.expectThat(timeoutIdentifier !== intervalIdentifier, "The setTimeout identifier and setInterval identifiers should be different.");
            resolve();
        }
    });

    suite.runTestCasesAndFinish();
}
</script>
</head>
<body onload="runTest()">
<p>Tests 'TimerRemove' Timeline event records.</p>
</body>
</html>
