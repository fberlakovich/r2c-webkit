<!DOCTYPE html>
<html>
<head>
<title>DoYouEvenBench</title>
<script src="resources/benchmark-runner.js" defer></script>
<script src="resources/tests.js" defer></script>
<style>
iframe { border: 1px solid black; }
ol { list-style: none; margin: 0; padding: 0; }
ol ol { margin-left: 2em; list-position: outside; }
.running { text-decoration: underline; }
.ran { color: grey; }
nav { position: absolute; right: 10px; }
</style>
</head>
<body>
<script>

window.addEventListener('load', function () {
    var self = BenchmarkRunner;
    var control = document.createElement('nav');

    var suites = BenchmarkRunner._suites;
    var ol = document.createElement('ol');
    var checkboxes = [];
    for (var suiteIndex = 0; suiteIndex < suites.length; suiteIndex++) {
        var suite = suites[suiteIndex];
        var li = document.createElement('li');
        var checkbox = document.createElement('input');
        checkbox.id = suite.name;
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.onchange = (function (suite, checkbox) { return function () { suite.disabled = !checkbox.checked; } })(suite, checkbox);
        checkbox.onchange();
        checkboxes.push(checkbox);

        li.appendChild(checkbox);
        var label = document.createElement('label');
        label.appendChild(document.createTextNode(self._testName(suite)));
        li.appendChild(label);
        label.htmlFor = checkbox.id;

        var testList = document.createElement('ol');
        for (var testIndex = 0; testIndex < suite.tests.length; testIndex++) {
            var testItem = document.createElement('li');
            var test = suite.tests[testIndex];
            var anchor = document.createElement('a');
            anchor.id = suite.name + '-' + test.name;
            test.anchor = anchor;
            anchor.appendChild(document.createTextNode(self._testName(suite, test.name)));
            testItem.appendChild(anchor);
            testList.appendChild(testItem);
        }
        li.appendChild(testList);

        ol.appendChild(li);
    }

    control.appendChild(ol);

    BenchmarkRunner.setClient({
        willRunTest: function (suite, test) {
            test.anchor.classList.add('running');
        },
        didRunTest: function (suite, test) {
            var classList = test.anchor.classList;
            classList.remove('running');
            classList.add('ran');
        },
        didRunSuites: function (measuredValues) {
            var results = '';
            var total = 0; // FIXME: Compute the total properly.
            for (var suiteName in measuredValues) {
                var suiteResults = measuredValues[suiteName];
                for (var testName in suiteResults.tests) {
                    var testResults = suiteResults.tests[testName];
                    for (var subtestName in testResults) {
                        results += suiteName + ' : ' + testName + ' : ' + subtestName
                            + ': ' + testResults[subtestName] + ' ms\n';
                    }
                }
                results += suiteName + ' : ' + suiteResults.total + ' ms\n';
                total += suiteResults.total;
            }
            results += 'Total : ' + total + ' ms\n';

            if (!results)
                return;

            var pre = document.createElement('pre');
            document.body.appendChild(pre);
            pre.textContent = results;
        }
    });

    var currentState = null;

    // Don't call step while step is already executing.
    var button = document.createElement('button');
    button.textContent = 'Step';
    button.onclick = function () {
        self.step(currentState).then(function (state) { currentState = state; });
    }
    control.appendChild(button);

    function callNextStep(state) {
        self.step(state).then(function (newState) {
            currentState = newState;
            if (newState)
                callNextStep(newState);
        });
    }

    var button = document.createElement('button');
    button.textContent = 'Run';
    button.onclick = function () { callNextStep(currentState); }
    control.appendChild(button);

    document.body.appendChild(control);
});

</script>
</body>
</html>
