2015-11-22  Andy Estes  <aestes@apple.com>

        Teach MiniBrowser how to enable the mock content filter
        https://bugs.webkit.org/show_bug.cgi?id=151540

        Reviewed by Andreas Kling.

        * MiniBrowser/Configurations/Base.xcconfig: Added WebCoreTestSupport and WTF to HEADER_SEARCH_PATHS.
        * MiniBrowser/Configurations/MiniBrowser.xcconfig: Linked against libWebCoreTestSupport.
        * MiniBrowser/Configurations/MiniBrowserBundle.xcconfig: Ditto.
        * MiniBrowser/MiniBrowser.xcodeproj/project.pbxproj: Added blocked-page.html.
        * MiniBrowser/MiniBrowserWebProcessPlugIn.m:
        (-[MiniBrowserWebProcessPlugIn webProcessPlugIn:initializeWithObject:]): Observed the WebMockContentFilterEnabler key path.
        (-[MiniBrowserWebProcessPlugIn dealloc]):
        (-[MiniBrowserWebProcessPlugIn observeValueForKeyPath:ofObject:change:context:]): Stored the value in _contentFilterEnabler.
        * MiniBrowser/blocked-page.html: Added.
        * MiniBrowser/mac/AppDelegate.m:
        (defaultConfiguration): Created a _WKProcessPoolConfiguration with MiniBrowser.wkbundle as the injected bundle.
        * MiniBrowser/mac/BrowserWindowController.h:
        * MiniBrowser/mac/BrowserWindowController.m:
        (+[BrowserWindowController contentFilteringBlockedString]): Returned an NSString containing blocked-page.html.
        * MiniBrowser/mac/SettingsController.h:
        * MiniBrowser/mac/SettingsController.m:
        (-[SettingsController _populateMenu]): Added [self _contentFilteringMenuItem] to the Settings menu.
        (-[SettingsController validateMenuItem:]): Validated the new menu items. Disabled Decision and Decision Point items if filtering is disabled.
        (-[SettingsController _contentFilteringMenuItem]): Returned a new Content Filtering menu item with a submenu.
        (-[SettingsController toggleContentFilteringEnabled:]): Toggled ContentFilteringEnabledKey.
        (-[SettingsController contentFilteringEnabled]): Returned value of ContentFilteringEnabledKey.
        (-[SettingsController setContentFilteringDecision:]): Set ContentFilterDecisionKey and called -[BrowserAppDelegate didChangeSettings].
        (-[SettingsController contentFilteringDecision]): Returned the value of ContentFilterDecisionKey as a WebMockContentFilterDecision.
        Defaulted to WebMockContentFilterDecisionAllow if the value is invalid.
        (-[SettingsController setContentFilteringDecisionPoint:]): Set ContentFilterDecisionPointKey and called -[BrowserAppDelegate didChangeSettings].
        (-[SettingsController contentFilteringDecisionPoint]): Returned the value of ContentFilterDecisionPointKey as a WebMockContentFilterDecisionPoint.
        Defaulted to WebMockContentFilterDecisionPointAfterWillSendRequest if the value is invalid.
        * MiniBrowser/mac/WK1BrowserWindowController.h:
        * MiniBrowser/mac/WK1BrowserWindowController.m:
        (-[WK1BrowserWindowController dealloc]):
        (-[WK1BrowserWindowController didChangeSettings]): Created a WebMockContentFilterEnabler with the current settings and stored it in _contentFilterEnabler.
        * MiniBrowser/mac/WK2BrowserWindowController.m:
        (-[WK2BrowserWindowController didChangeSettings]): Created a WebMockContentFilterEnabler and set it as the object for the eponymous bundle parameter.
        * TestWebKitAPI/Configurations/TestWebKitAPI.xcconfig: Linked against libWebCoreTestSupport.
        * TestWebKitAPI/Tests/WebKit2Cocoa/ContentFiltering.mm:
        (configurationWithContentFilterSettings): Converted to use WebMockContentFilterEnabler, WebMockContentFilterDecision, and WebMockContentFilterDecisionPoint.
        (TEST): Ditto.
        (downloadTest): Ditto.
        (+[MockContentFilterEnabler supportsSecureCoding]): Deleted.
        (-[MockContentFilterEnabler copyWithZone:]): Deleted.
        (-[MockContentFilterEnabler initWithCoder:]): Deleted.
        (-[MockContentFilterEnabler initWithDecision:decisionPoint:]): Deleted.
        (-[MockContentFilterEnabler encodeWithCoder:]): Deleted.
        * TestWebKitAPI/Tests/WebKit2Cocoa/ContentFilteringPlugIn.mm:
        (-[ContentFilteringPlugIn webProcessPlugIn:initializeWithObject:]): Converted to use WebMockContentFilterEnabler.
        (-[ContentFilteringPlugIn dealloc]): Ditto.
        (-[ContentFilteringPlugIn observeValueForKeyPath:ofObject:change:context:]): Ditto.
        (+[MockContentFilterEnabler supportsSecureCoding]): Deleted.
        (-[MockContentFilterEnabler copyWithZone:]): Deleted.
        (-[MockContentFilterEnabler initWithCoder:]): Deleted.
        (-[MockContentFilterEnabler dealloc]): Deleted.
        (-[MockContentFilterEnabler encodeWithCoder:]): Deleted.

2015-11-24  Gyuyoung Kim  <gyuyoung.kim@webkit.org>

        REGRESSION(r192053): MiniBrowser doesn't exit when clicking on the close-window button
        https://bugs.webkit.org/show_bug.cgi?id=151567

        Reviewed by Darin Adler.

        * MiniBrowser/efl/main.c: Call window_close() instead of ewk_view_try_close().
        (on_window_deletion):

2015-11-23  Carlos Garcia Campos  <cgarcia@igalia.com>

        [GTK] Use the network process unconditionally
        https://bugs.webkit.org/show_bug.cgi?id=151541

        Reviewed by Alex Christensen.

        Fix TestInspectorServer test. Do not assume we already have the
        title we want when the page has been loaded, since the title is
        changed afterwards. So, check if the title has already been set,
        and if not wait for it.

        * TestWebKitAPI/Tests/WebKit2Gtk/TestInspectorServer.cpp:
        (openRemoteDebuggingSession):

2015-11-23  Alex Christensen  <achristensen@webkit.org>

        Fix crash in ~WebProcessPool when using Geolocation with useNetworkProcess=true
        https://bugs.webkit.org/show_bug.cgi?id=151532

        Reviewed by Benjamin Poulain.

        * TestWebKitAPI/Tests/WebKit2/Geolocation.cpp:
        (TestWebKitAPI::GeolocationTransitionToHighAccuracyStateTracker::eventsChanged):
        (TestWebKitAPI::TEST):
        (TestWebKitAPI::GeolocationTransitionToLowAccuracyStateTracker::eventsChanged):
        (TestWebKitAPI::GeolocationTransitionToHighAccuracyStateTracker::GeolocationTransitionToHighAccuracyStateTracker): Deleted.
        (TestWebKitAPI::GeolocationTransitionToLowAccuracyStateTracker::GeolocationTransitionToLowAccuracyStateTracker): Deleted.
        Properly load about:blank in all WebViews to clean up.  Without this change, we had a 
        Geolocation provider stopping after its state tracker was destroyed with its stack frame,
        so it was calling a function on a test object that had gone out of scope.
        Also, call WKContextSetUsesNetworkProcess(context, true) to show what crash this fixed,
        but that will become the default soon and that call will be removed.

2015-11-22  David Kilzer  <ddkilzer@apple.com>

        run-webkit-tests: http server for imported W3C tests doesn't work with --layout-tests-directory switch
        <http://webkit.org/b/151542>

        Reviewed by Daniel Bates.

        * Scripts/webkitpy/layout_tests/servers/web_platform_test_server.py:
        (base_url): Use the Port object (already passed in) to give us
        the path to the LayoutTests directory, which already checks for a
        --layout-tests-directory command-line switch.
        (WebPlatformTestServer.__init__): Remove layout_test_results_dir
        argument since we can get this from the Port object already
        passed in via Port.results_directory().  Also switch to use
        Port.layout_tests_dir() to get the LayoutTests directory.

        * Scripts/webkitpy/layout_tests/servers/web_platform_test_server_unittest.py:
        (TestWebPlatformTestServer.test_custom_layout_tests_directory):
        Add test case for custom LayoutTests directory.
        (TestWebPlatformTestServer.test_previously_spawned_instance):
        Update Port object to set mock results directory as if it was
        set on the command-line.  Remove unneeded argument from
        WebPlatformTestServer constructor.
        (TestWebPlatformTestServer.test_corrupted_subserver_files): Ditto.

        * Scripts/webkitpy/port/base.py:
        (Port.to.start_web_platform_test_server): Remove unneeded
        argument from WebPlatformTestServer constuctor.

2015-11-22  Carlos Garcia Campos  <cgarcia@igalia.com>

        [GTK] Some unit tests fail when using the network process
        https://bugs.webkit.org/show_bug.cgi?id=151490

        Reviewed by Martin Robinson.

        Run the soup server in a separate thread in TestResources test to
        avoid deadlocks.

        This fixes /webkit2/WebKitWebView/sync-request-on-max-conns and
        /webkit2/WebKitWebResource/get-data when using the network process.

        * TestWebKitAPI/Tests/WebKit2Gtk/TestResources.cpp:
        (beforeAll): Create the WebKitTestServer with ServerRunInThread flag.
        * TestWebKitAPI/gtk/WebKit2Gtk/WebKitTestServer.cpp:
        (WebKitTestServer::WebKitTestServer): When ServerRunInThread is
        present, create a WorkQueue to run the server.
        (WebKitTestServer::run): Run the server in the work queue if it
        has been created.
        * TestWebKitAPI/gtk/WebKit2Gtk/WebKitTestServer.h: Convert server
        type into server options as flags.

2015-11-22  Carlos Garcia Campos  <cgarcia@igalia.com>

        [GTK] ImageDiff should normalize the diff image
        https://bugs.webkit.org/show_bug.cgi?id=151261

        Reviewed by Sergio Villar Senin.

        * ImageDiff/gtk/ImageDiff.cpp:
        (readPixbufFromStdin): Fix memory leak.
        (differenceImageFromDifferenceBuffer): Normalize diff buffer.
        (calculateDifference): Pass max distance to differenceImageFromDifferenceBuffer.

== Rolled over to ChangeLog-2015-11-21 ==
